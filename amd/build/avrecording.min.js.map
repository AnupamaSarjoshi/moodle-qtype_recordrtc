{"version":3,"sources":["../src/avrecording.js"],"names":["define","Log","ModalFactory","checkCanWork","navigator","mediaDevices","window","MediaRecorder","location","protocol","host","indexOf","Recorder","type","mediaElement","noMediaPlaceholder","button","otherControls","filename","owner","settings","questionDiv","recorder","mediaStream","mediaRecorder","chunks","bytesRecordedSoFar","secondsRemaining","countdownTicker","addEventListener","e","debug","preventDefault","dataset","state","startRecording","stopRecording","uploadMediaToServer","setUploadMessage","classList","add","setOtherControlsEnabled","fetchRequest","XMLHttpRequest","open","src","responseType","handleRecordingFetched","send","disabled","disableOtherButtons","hidePlayerDuringRecording","parentElement","remove","textContent","mediaConstraints","getUserMedia","then","handleCaptureStarting","catch","handleCaptureFailed","stream","options","getRecordingOptions","ondataavailable","handleDataAvailable","onstop","handleRecordingHasStopped","start","srcObject","muted","play","controls","startCountdownTimer","focus","event","data","size","maxUploadSize","localStorage","getItem","setItem","showAlert","removeItem","push","M","core_formchangechecker","pathname","endsWith","set_form_changed","stopCountdownTimer","innerText","util","get_string","stop","tracks","getTracks","i","length","blob","Blob","mimeType","URL","createObjectURL","notifyRecordingComplete","error","stringName","name","replace","toLowerCase","enableAllButtons","timeLimit","innerHTML","updateTimerDisplay","setInterval","clearInterval","secs","mins","Math","round","querySelector","pad","val","valString","target","status","response","formData","FormData","append","cfg","sesskey","uploadRepositoryId","draftItemId","contextId","uploadRequest","handleUploadReadyStateChanged","upload","handleUploadProgress","handleUploadError","handleUploadAbort","wwwroot","readyState","loaded","total","langString","a","setTimeout","enabled","forEach","node","audioBitsPerSecond","parseInt","audioBitRate","videoBitsPerSecond","videoBitRate","videoWidth","videoHeight","mimeTypes","isTypeSupported","disableOrEnableButtons","currentButton","buttons","getElementsByTagName","id","inputs","getAttribute","AudioSettings","audio","VideoSettings","width","height","video","ideal","RecordRtcQuestion","questionId","document","getElementById","result","recorderElements","querySelectorAll","rElement","mediaType","recordingFilename","typeInfo","subject","create","types","ALERT","title","body","modal","show","init","js_pending","js_complete"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n//\n\n/**\n * JavaScript to the recording work.\n *\n * We would like to thank the creators of atto_recordrtc, whose\n * work inspired this.\n *\n * @package   qtype_recordrtc\n * @copyright 2019 The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/log', 'core/modal_factory'], function(Log, ModalFactory) {\n\n    /**\n     * Verify that the question type can work. If not, show a warning.\n     *\n     * @return {string} 'ok' if it looks OK, else 'nowebrtc' or 'nothttps' if there is a problem.\n     */\n    function checkCanWork() {\n        if (!(navigator.mediaDevices && window.MediaRecorder)) {\n            return 'nowebrtc';\n        }\n\n        if (!(location.protocol === 'https:' || location.host.indexOf('localhost') !== -1)) {\n            return 'nothttps';\n        }\n\n        return 'ok';\n    }\n\n    /**\n     * Object for actually doing the recording.\n     *\n     * The recorder can be in one of 4 states, which is stored in a data-state\n     * attribute on the button. The states are:\n     *  - new:       there is no recording yet. Button shows 'Start recording'.\n     *  - recording: buttons shows a countdown of remaining time. Media is being recorded.\n     *  - saving:    buttons shows a progress indicator.\n     *  - recorded:  button shows 'Record again'.\n     *\n     * @param {(AudioSettings|VideoSettings)} type\n     * @param {HTMLMediaElement} mediaElement\n     * @param {HTMLMediaElement} noMediaPlaceholder\n     * @param {HTMLButtonElement} button\n     * @param {NodeList} otherControls other controls to disable while recording is in progress.\n     * @param {string} filename the name of the audio (.ogg) or video file (.webm)\n     * @param {Object} owner\n     * @param {Object} settings\n     * @param {Object} questionDiv\n     * @constructor\n     */\n    function Recorder(type, mediaElement, noMediaPlaceholder,\n                      button, otherControls, filename,\n                      owner, settings, questionDiv) {\n        /**\n         * @type {Recorder} reference to this recorder, for use in event handlers.\n         */\n        var recorder = this;\n\n        /**\n         * @type {MediaStream} during recording, the stream of incoming media.\n         */\n        var mediaStream = null;\n\n        /**\n         * @type {MediaRecorder} the recorder that is capturing stream.\n         */\n        var mediaRecorder = null;\n\n        /**\n         * @type {Blob[]} the chunks of data that have been captured so far duing the current recording.\n         */\n        var chunks = [];\n\n        /**\n         * @type {number} number of bytes recorded so far, so we can auto-stop\n         * before hitting Moodle's file-size limit.\n         */\n        var bytesRecordedSoFar = 0;\n\n        /**\n         * @type {number} time left in seconds, so we can auto-stop at the time limit.\n         */\n        var secondsRemaining = 0;\n\n        /**\n         * @type {number} intervalID returned by setInterval() while the timer is running.\n         */\n        var countdownTicker = 0;\n\n        button.addEventListener('click', handleButtonClick);\n        this.uploadMediaToServer = uploadMediaToServer; // Make this method available.\n\n        /**\n         * Handles clicks on the start/stop button.\n         *\n         * @param {Event} e\n         */\n        function handleButtonClick(e) {\n            Log.debug('Start/stop button clicked.');\n            e.preventDefault();\n            switch (button.dataset.state) {\n                case 'new':\n                case 'recorded':\n                    startRecording();\n                    break;\n                case 'recording':\n                    stopRecording();\n                    break;\n            }\n        }\n\n        /**\n         * Start recording (because the button was clicked).\n         */\n        function startRecording() {\n            button.disabled = true;\n\n            // Disable other question buttons when current widget stared recording.\n            disableOtherButtons(button);\n\n            if (type.hidePlayerDuringRecording) {\n                mediaElement.parentElement.classList.add('hide');\n                noMediaPlaceholder.classList.remove('hide');\n                noMediaPlaceholder.textContent = '';\n            } else {\n                mediaElement.parentElement.classList.remove('hide');\n                noMediaPlaceholder.classList.add('hide');\n            }\n\n            // Change look of recording button.\n            button.classList.remove('btn-outline-danger');\n            button.classList.add('btn-danger');\n\n            // Empty the array containing the previously recorded chunks.\n            chunks = [];\n            bytesRecordedSoFar = 0;\n            Log.debug('Audio/video question: Starting recording with media constraints');\n            Log.debug(type.mediaConstraints);\n            navigator.mediaDevices.getUserMedia(type.mediaConstraints)\n                .then(handleCaptureStarting)\n                .catch(handleCaptureFailed);\n        }\n\n        /**\n         * Callback once getUserMedia has permission from the user to access the recording devices.\n         *\n         * @param {MediaStream} stream the stream to record.\n         */\n        function handleCaptureStarting(stream) {\n            mediaStream = stream;\n\n            // Initialize MediaRecorder events and start recording.\n            var options = getRecordingOptions();\n            Log.debug('Audio/video question: creating recorder with opptions');\n            Log.debug(options);\n            mediaRecorder = new MediaRecorder(stream, options);\n\n            mediaRecorder.ondataavailable = handleDataAvailable;\n            mediaRecorder.onstop = handleRecordingHasStopped;\n            Log.debug('Audio/video question: starting recording.');\n            mediaRecorder.start(1000); // Capture in one-second chunks. Firefox requires that.\n\n            // Setup the UI for during recording.\n            mediaElement.srcObject = stream;\n            mediaElement.muted = true;\n            if (!type.hidePlayerDuringRecording) {\n                mediaElement.play();\n                mediaElement.controls = false;\n            }\n            button.dataset.state = 'recording';\n            startCountdownTimer();\n\n            setOtherControlsEnabled(false);\n\n            // Make button clickable again, to allow stopping recording.\n            button.disabled = false;\n            button.focus();\n        }\n\n        /**\n         * Callback that is called by the media system for each Chunk of data.\n         *\n         * @param {BlobEvent} event\n         */\n        function handleDataAvailable(event) {\n            Log.debug('Audio/video question: chunk of ' + event.data.size + ' bytes received.');\n\n            // Check there is space to store the next chunk, and if not stop.\n            bytesRecordedSoFar += event.data.size;\n            if (settings.maxUploadSize >= 0 && bytesRecordedSoFar >= settings.maxUploadSize) {\n\n                // Extra check to avoid alerting twice.\n                if (!localStorage.getItem('alerted')) {\n                    localStorage.setItem('alerted', 'true');\n                    stopRecording();\n                    owner.showAlert('nearingmaxsize');\n\n                } else {\n                    localStorage.removeItem('alerted');\n                }\n            }\n\n            // Store the next chunk of data.\n            chunks.push(event.data);\n\n            // Notify form-change-checker that there is now unsaved data.\n            // But, don't do this in question preview where it is just annoying.\n            if (typeof M.core_formchangechecker !== 'undefined' &&\n                !window.location.pathname.endsWith('/question/preview.php')) {\n                M.core_formchangechecker.set_form_changed();\n            }\n        }\n\n        /**\n         * Start recording (because the button was clicked or because we have reached a limit).\n         */\n        function stopRecording() {\n            // Disable the button while things change.\n            button.disabled = false;\n\n            // Stop the count-down timer.\n            stopCountdownTimer();\n\n            // Update the button.\n            button.innerText = M.util.get_string('recordagain', 'qtype_recordrtc');\n            button.classList.remove('btn-danger');\n            button.classList.add('btn-outline-danger');\n\n            setOtherControlsEnabled(true);\n\n            // Ask the recording to stop.\n            Log.debug('Audio/video question: stopping recording.');\n            mediaRecorder.stop();\n\n            // Also stop each individual MediaTrack.\n            var tracks = mediaStream.getTracks();\n            for (var i = 0; i < tracks.length; i++) {\n                tracks[i].stop();\n            }\n        }\n\n        /**\n         * Callback that is called by the media system once recording has finished.\n         */\n        function handleRecordingHasStopped() {\n            // Set source of audio player.\n            Log.debug('Audio/video question: recording stopped.');\n            var blob = new Blob(chunks, {type: mediaRecorder.mimeType});\n            mediaElement.srcObject = null;\n            mediaElement.src = URL.createObjectURL(blob);\n\n            // Show audio player with controls enabled, and unmute.\n            mediaElement.muted = false;\n            mediaElement.controls = true;\n            mediaElement.parentElement.classList.remove('hide');\n            noMediaPlaceholder.classList.add('hide');\n            mediaElement.focus();\n\n            button.innerText = M.util.get_string('recordagain', 'qtype_recordrtc');\n            button.disabled = false;\n            button.classList.remove('btn-danger');\n            button.classList.add('btn-outline-danger');\n            button.dataset.state = 'recorded';\n\n            if (chunks.length > 0) {\n                owner.notifyRecordingComplete(recorder);\n            }\n        }\n\n        /**\n         * Function that handles errors from the recorder.\n         *\n         * @param {DOMException} error\n         */\n        function handleCaptureFailed(error) {\n            Log.debug('Audio/video question: error received');\n            Log.debug(error);\n\n            button.innerText = M.util.get_string('recordingfailed', 'qtype_recordrtc');\n            button.disabled = false;\n            button.classList.remove('btn-danger');\n            button.classList.add('btn-outline-danger');\n            button.dataset.state = 'new';\n\n            // Changes 'CertainError' -> 'gumcertain' to match language string names.\n            var stringName = 'gum' + error.name.replace('Error', '').toLowerCase();\n\n            owner.showAlert(stringName);\n            enableAllButtons();\n        }\n\n        /**\n         * Start the countdown timer from settings.timeLimit.\n         */\n        function startCountdownTimer() {\n            secondsRemaining = settings.timeLimit;\n\n            button.innerHTML = M.util.get_string('stoprecording', 'qtype_recordrtc') + ' (<span></span>)';\n            updateTimerDisplay();\n            countdownTicker = setInterval(updateTimerDisplay, 1000);\n        }\n\n        /**\n         * Stop the countdown timer.\n         */\n        function stopCountdownTimer() {\n            if (countdownTicker !== 0) {\n                clearInterval(countdownTicker);\n                countdownTicker = 0;\n            }\n        }\n\n        /**\n         * Update the countdown timer, and stop recording if we have reached 0.\n         */\n        function updateTimerDisplay() {\n            var secs = secondsRemaining % 60;\n            var mins = Math.round((secondsRemaining - secs) / 60);\n            button.querySelector('span').innerText = pad(mins) + ':' + pad(secs);\n\n            if (secondsRemaining === -1) {\n                stopRecording();\n            }\n            secondsRemaining -= 1;\n        }\n\n        /**\n         * Zero-pad a string to be at least two characters long.\n         *\n         * Used fro\n         * @param {number} val, e.g. 1 or 10\n         * @return {string} e.g. '01' or '10'.\n         */\n        function pad(val) {\n            var valString = val + '';\n\n            if (valString.length < 2) {\n                return '0' + valString;\n            } else {\n                return valString;\n            }\n        }\n\n        /**\n         * Upload the recorded media back to Moodle.\n         */\n        function uploadMediaToServer() {\n            setUploadMessage('uploadpreparing');\n            noMediaPlaceholder.classList.add('hide');\n            setOtherControlsEnabled(false);\n\n            var fetchRequest = new XMLHttpRequest();\n\n            // Get media of audio/video tag.\n            fetchRequest.open('GET', mediaElement.src);\n            fetchRequest.responseType = 'blob';\n            fetchRequest.addEventListener('load', handleRecordingFetched);\n            fetchRequest.send();\n        }\n\n        /**\n         * Callback called once we have the data from the media element.\n         *\n         * @param {ProgressEvent} e\n         */\n        function handleRecordingFetched(e) {\n            var fetchRequest = e.target;\n            if (fetchRequest.status !== 200) {\n                // No data.\n                return;\n            }\n\n            // Blob is now the media that the audio/video tag's src pointed to.\n            var blob = fetchRequest.response;\n\n            // Create FormData to send to PHP filepicker-upload script.\n            var formData = new FormData();\n            formData.append('repo_upload_file', blob, filename);\n            formData.append('sesskey', M.cfg.sesskey);\n            formData.append('repo_id', settings.uploadRepositoryId);\n            formData.append('itemid', settings.draftItemId);\n            formData.append('savepath', '/');\n            formData.append('ctx_id', settings.contextId);\n            formData.append('overwrite', 1);\n\n            var uploadRequest = new XMLHttpRequest();\n            uploadRequest.addEventListener('readystatechange', handleUploadReadyStateChanged);\n            uploadRequest.upload.addEventListener('progress', handleUploadProgress);\n            uploadRequest.addEventListener('error', handleUploadError);\n            uploadRequest.addEventListener('abort', handleUploadAbort);\n            uploadRequest.open('POST', M.cfg.wwwroot + '/repository/repository_ajax.php?action=upload');\n            uploadRequest.send(formData);\n        }\n\n        /**\n         * Callback for when the upload completes.\n         * @param {ProgressEvent} e\n         */\n        function handleUploadReadyStateChanged(e) {\n            var uploadRequest = e.target;\n            if (uploadRequest.readyState === 4 && uploadRequest.status === 200) {\n                // When request finished and successful.\n                setUploadMessage('uploadcomplete');\n                enableAllButtons();\n            } else if (uploadRequest.status === 404) {\n                setUploadMessage('uploadfailed404');\n                enableAllButtons();\n            }\n            setOtherControlsEnabled(true);\n        }\n\n        /**\n         * Callback for updating the upload progress.\n         * @param {ProgressEvent} e\n         */\n        function handleUploadProgress(e) {\n            setUploadMessage('uploadprogress', Math.round(e.loaded / e.total * 100) + '%');\n        }\n\n        /**\n         * Callback for when the upload fails with an error.\n         */\n        function handleUploadError() {\n            setUploadMessage('uploadfailed');\n            enableAllButtons();\n        }\n\n        /**\n         * Callback for when the upload fails with an error.\n         */\n        function handleUploadAbort() {\n            setUploadMessage('uploadaborted');\n            enableAllButtons();\n        }\n\n        /**\n         * Display a progress message in the upload progress area.\n         *\n         * @param {string} langString\n         * @param {Object|String} a optional variable to populate placeholder with\n         */\n        function setUploadMessage(langString, a) {\n            button.innerText = M.util.get_string(langString, 'qtype_recordrtc', a);\n            button.classList.add('saving-message');\n            if (langString === 'uploadcomplete') {\n                setTimeout(function() {\n                    button.classList.remove('saving-message');\n                    button.innerText = M.util.get_string('recordagain', 'qtype_recordrtc');\n                }, 1000);\n            }\n        }\n\n        /**\n         * Set the state of the otherControls to enabled or disabled.\n         *\n         * @param {boolean} enabled true to enable. False to disable.\n         */\n        function setOtherControlsEnabled(enabled) {\n            otherControls.forEach(function(node) {\n                node.disabled = !enabled;\n            });\n        }\n\n        /**\n         * Select best options for the recording codec.\n         *\n         * @returns {Object}\n         */\n        function getRecordingOptions() {\n            var options = {};\n\n            // Get the relevant bit rates from settings.\n            if (type.name === 'audio') {\n                options.audioBitsPerSecond = parseInt(settings.audioBitRate, 10);\n            } else if (type.name === 'video') {\n                options.videoBitsPerSecond = parseInt(settings.videoBitRate, 10);\n                options.videoWidth = parseInt(settings.videoWidth, 10);\n                options.videoHeight = parseInt(settings.videoHeight, 10);\n            }\n\n            // Go through our list of mimeTypes, and take the first one that will work.\n            for (var i = 0; i < type.mimeTypes.length; i++) {\n                if (MediaRecorder.isTypeSupported(type.mimeTypes[i])) {\n                    options.mimeType = type.mimeTypes[i];\n                    break;\n                }\n            }\n\n            return options;\n        }\n\n        /**\n         * Disables/enabales other question buttons when current widget started recording/finshed recording.\n         *\n         * @param {Object} questionDiv, question outer div html\n         * @param {object} currentButton, the button of current widget being pressed.\n         * @param {boolean} disabled,\n         * @returns {null}\n         */\n        function disableOrEnableButtons(questionDiv, currentButton, disabled = false) {\n            let state = 'new';\n            let buttons = questionDiv.getElementsByTagName('button');\n            for (let i = 0; i < buttons.length; i++) {\n                state = buttons[i].dataset.state;\n                if (currentButton.id === buttons[i].id) {\n                    continue;\n                }\n                buttons[i].disabled = disabled;\n            }\n            let inputs = questionDiv.getElementsByTagName('input');\n            for (let i = 0; i < inputs.length; i++) {\n                let button = inputs[i];\n                let type = button.getAttribute('type') || 'submit'; // Submit is the default.\n                if (type) {\n                    button.disabled = disabled;\n\n                    // Do not enable the submit button until all widgets in the question have some recording.\n                    if (state === 'new') {\n                        button.disabled = true;\n                    }\n                }\n            }\n        }\n\n        /**\n         * Enable all buttons.\n         */\n        function enableAllButtons() {\n            disableOrEnableButtons(questionDiv, button);\n        }\n\n        /**\n         * Disable other buttons.\n         *\n         * @param {object} button, current button\n         */\n        function disableOtherButtons(button) {\n            disableOrEnableButtons(questionDiv, button, true);\n        }\n    }\n\n    /**\n     * Fixed object which has the info specific to recording audio.\n     * @type {Object}\n     */\n    var AudioSettings = {\n        name: 'audio',\n        hidePlayerDuringRecording: true,\n        mediaConstraints: {\n            audio: true\n        },\n        mimeTypes: [\n            'audio/webm;codecs=opus',\n            'audio/ogg;codecs=opus'\n        ]\n    };\n\n    /**\n     * Fixed object which has the info specific to recording video.\n     * @type {Object}\n     */\n    function VideoSettings (width, height) {\n        return {\n            name: 'video',\n            hidePlayerDuringRecording: false,\n            mediaConstraints: {\n                audio: true,\n                video: {\n                    width: {ideal: width},\n                    height: {ideal: height}\n                }\n            },\n            mimeTypes: [\n                'video/webm;codecs=vp9,opus',\n                'video/webm;codecs=h264,opus',\n                'video/webm;codecs=vp8,opus'\n            ]\n        };\n    }\n\n    /**\n     * Represents one record audio or video question.\n     *\n     * @param {string} questionId id of the outer question div.\n     * @param {Object} settings like audio bit rate.\n     * @param {string} type 'audio' or 'video'.\n     * @constructor\n     */\n    function RecordRtcQuestion(questionId, settings) {\n        var questionDiv = document.getElementById(questionId);\n\n        // Check if the RTC API can work here.\n        var result = checkCanWork();\n        if (result === 'nothttps') {\n            questionDiv.querySelector('.https-warning').classList.remove('hide');\n            return;\n        } else if (result === 'nowebrtc') {\n            questionDiv.querySelector('.no-webrtc-warning').classList.remove('hide');\n            return;\n        }\n\n        // We may have more than one widget in a question.\n        var recorderElements = questionDiv.querySelectorAll('.record-widget');\n        recorderElements.forEach (function(rElement) {\n            // Get the key UI elements.\n            var type = rElement.dataset.mediaType;\n            var button = rElement.querySelector('.record-button button');\n            var mediaElement = rElement.querySelector('.media-player ' + type);\n            var noMediaPlaceholder = rElement.querySelector('.no-recording-placeholder');\n            var otherControls = rElement.querySelectorAll('input.submit[type=submit]');\n            var filename = rElement.dataset.recordingFilename;\n\n            // Get the appropriate options.\n            var typeInfo;\n            if (type === 'audio') {\n                typeInfo = AudioSettings;\n            } else {\n                typeInfo = VideoSettings(settings.videoWidth, settings.videoHeight);\n            }\n\n            // Make the callback functions available.\n            this.showAlert = showAlert;\n            this.notifyRecordingComplete = notifyRecordingComplete;\n\n            // Create the recorder.\n            new Recorder(typeInfo, mediaElement, noMediaPlaceholder, button,\n                otherControls, filename, this, settings, questionDiv);\n        });\n\n        /**\n         * Show a modal alert.\n         *\n         * @param {string} subject Subject is the content of the alert (which error the alert is for).\n         * @return {Promise}\n         */\n        function showAlert(subject) {\n            return ModalFactory.create({\n                type: ModalFactory.types.ALERT,\n                title: M.util.get_string(subject + '_title', 'qtype_recordrtc'),\n                body: M.util.get_string(subject, 'qtype_recordrtc'),\n            }).then(function(modal) {\n                modal.show();\n                return modal;\n            });\n        }\n\n        /**\n         * Callback called when the recofding is\n         *\n         * @param {Recorder} recorder the recorder.\n         */\n        function notifyRecordingComplete(recorder) {\n            recorder.uploadMediaToServer();\n        }\n    }\n\n    return {\n        /**\n         * Initialise a record audio or video question.\n         *\n         * @param {string} questionId id of the outer question div.\n         * @param {Object} settings like audio bit rate.\n         */\n        init: function(questionId, settings) {\n            M.util.js_pending('init-' + questionId);\n            new RecordRtcQuestion(questionId, settings);\n            M.util.js_complete('init-' + questionId);\n        }\n    };\n});\n"],"file":"avrecording.min.js"}