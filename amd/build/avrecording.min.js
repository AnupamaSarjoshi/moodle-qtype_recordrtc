define(["core/log","core/modal_factory"],function(a,b){function c(){return navigator.mediaDevices&&window.MediaRecorder?"https:"!==location.protocol&&location.host.indexOf("localhost")===-1?"nothttps":"ok":"nowebrtc"}function d(b,c,d,e,f,g,h){function i(b){switch(a.debug("Start/stop button clicked."),b.preventDefault(),d.dataset.state){case"new":case"recorded":j();break;case"recording":m()}}function j(){d.disabled=!0,b.hidePlayerDuringRecording?c.parentElement.classList.add("hide"):c.parentElement.classList.remove("hide"),e.classList.add("hide"),d.classList.remove("btn-outline-danger"),d.classList.add("btn-danger"),F=[],G=0,a.debug("Audio question: Starting recording with media constraints"),a.debug(b.mediaConstraints),navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(k)["catch"](o)}function k(b){D=b;var e=B();a.debug("Audio question: creating recorder with opptions"),a.debug(e),E=new MediaRecorder(b,e),E.ondataavailable=l,E.onstop=n,a.debug("Audio question: starting recording."),E.start(1e3),c.srcObject=b,c.setAttribute("muted",""),d.dataset.state="recording",p(),A(!1),d.disabled=!1,d.focus()}function l(b){a.debug("Audio question: chunk of "+b.data.size+" bytes received."),G+=b.data.size,h.maxUploadSize>=0&&G>=h.maxUploadSize&&(localStorage.getItem("alerted")?localStorage.removeItem("alerted"):(localStorage.setItem("alerted","true"),m(),g.showAlert("nearingmaxsize"))),F.push(b.data),"undefined"==typeof M.core_formchangechecker||window.location.pathname.endsWith("/question/preview.php")||M.core_formchangechecker.set_form_changed()}function m(){d.disabled=!0,setTimeout(function(){d.disabled=!1},1e3),q(),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),A(!0),a.debug("Audio question: stopping recording."),E.stop();for(var b=D.getTracks(),c=0;c<b.length;c++)b[c].stop()}function n(){a.debug("Audio question: recording stopped.");var b=new Blob(F,{type:E.mimeType});c.srcObject=null,c.src=URL.createObjectURL(b),c.muted=!1,c.controls=!0,c.parentElement.classList.remove("hide"),c.focus(),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="recorded",F.length>0&&g.notifyRecordingComplete(C)}function o(b){a.debug("Audio question: error received"),a.debug(b),d.innerText=M.util.get_string("recordingfailed","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="new";var c="gum"+b.name.replace("Error","").toLowerCase();g.showAlert(c)}function p(){H=h.timeLimit+1,d.innerHTML=M.util.get_string("stoprecording","qtype_recordrtc")+" (<span></span>)",r(),I=setInterval(r,1e3)}function q(){0!==I&&(clearInterval(I),I=0)}function r(){H-=1;var a=H%60,b=Math.round((H-a)/60);d.querySelector("span").innerText=s(b)+":"+s(a),0===H&&m()}function s(a){var b=a+"";return b.length<2?"0"+b:b}function t(){z("uploadpreparing"),e.classList.remove("hide"),A(!1);var a=new XMLHttpRequest;a.open("GET",c.src),a.responseType="blob",a.addEventListener("load",u),a.send()}function u(a){var c=a.target;if(200===c.status){var d=c.response,e=new FormData;e.append("repo_upload_file",d,b.recordingFilename),e.append("sesskey",M.cfg.sesskey),e.append("repo_id",h.uploadRepositoryId),e.append("itemid",h.draftItemId),e.append("savepath","/"),e.append("ctx_id",h.contextId),e.append("overwrite",1);var f=new XMLHttpRequest;f.addEventListener("readystatechange",v),f.upload.addEventListener("progress",w),f.addEventListener("error",x),f.addEventListener("abort",y),f.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload"),f.send(e)}}function v(a){var b=a.target;4===b.readyState&&200===b.status?z("uploadcomplete"):404===b.status&&z("uploadfailed404"),A(!0)}function w(a){z("uploadprogress",Math.round(a.loaded/a.total*100)+"%")}function x(){z("uploadfailed")}function y(){z("uploadaborted")}function z(a,b){e.querySelector("small").innerText=M.util.get_string(a,"qtype_recordrtc",b)}function A(a){f.forEach(function(b){b.disabled=!a})}function B(){var a={};a.audioBitsPerSecond=parseInt(h.audioBitRate,10),"video"===b.name&&(a.videoBitsPerSecond=parseInt(h.videoBitRate,10));for(var c=0;c<b.mimeTypes.length;c++)if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}return a}var C=this,D=null,E=null,F=[],G=0,H=0,I=0;d.addEventListener("click",i),this.uploadMediaToServer=t}function e(a,e,h){function i(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){return a.show(),a})}function j(a){a.uploadMediaToServer()}var k=document.getElementById(a),l=c();if("nothttps"===l)return void k.querySelector(".https-warning").classList.remove("hide");if("nowebrtc"===l)return void k.querySelector(".no-webrtc-warning").classList.remove("hide");var m;m="audio"===h?f:g;var n=k.querySelector(".record-button button"),o=k.querySelector(".media-player "+h),p=k.querySelector(".saving-message"),q=k.querySelectorAll("input.submit[type=submit]");this.showAlert=i,this.notifyRecordingComplete=j,new d(m,o,n,p,q,this,e)}var f={name:"audio",recordingFilename:"recording.ogg",hidePlayerDuringRecording:!0,mediaConstraints:{audio:!0},mimeTypes:["audio/webm;codecs=opus","audio/ogg;codecs=opus"]},g={name:"video",recordingFilename:"recording.webm",hidePlayerDuringRecording:!1,mediaConstraints:{audio:!0,video:{width:{ideal:640},height:{ideal:480}}},mimeTypes:["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]};return{init:function(a,b,c){M.util.js_pending("init-"+a),new e(a,b,c),M.util.js_complete("init-"+a)}}});