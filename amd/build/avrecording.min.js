define(["jquery","core/modal_factory"],function(a,b){function c(){return navigator.mediaDevices&&window.MediaRecorder?"https:"!==window.location.protocol&&window.location.host.indexOf("localhost")===-1?"nothttps":"ok":"nowebrtc"}function d(b,c,d,e,f){function g(a){switch(a.preventDefault(),d.dataset.state){case"new":case"recorded":h();break;case"recording":k()}}function h(){a(d).attr("disabled",!0),b.hidePlayerDuringRecording?a(c).closest("div").addClass("hide"):a(c).closest("div").removeClass("hide"),a(d).removeClass("btn-outline-danger"),a(d).addClass("btn-danger"),u=[],v=0,navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(i)["catch"](m)}function i(a){s=a,t=new MediaRecorder(a,r()),t.ondataavailable=j,t.onstop=l,t.start(1e3),c.srcObject=a,d.dataset.state="recording",c.attr("muted",!0),n(),d.attr("disabled",!1)}function j(a){v+=a.data.size,v>=f.maxUploadSize&&(window.localStorage.getItem("alerted")?window.localStorage.removeItem("alerted"):(window.localStorage.setItem("alerted","true"),k(),e.showAlert("nearingmaxsize"))),u.push(a.data)}function k(){a(d).attr("disabled",!0),window.setTimeout(function(){a(d).attr("disabled",!1)},1e3),o(),a(d).innerText=M.util.get_string("recordagain","qtype_recordrtc"),a(d).removeClass("btn-danger"),a(d).addClass("btn-outline-danger"),t.stop();for(var b=s.getTracks(),c=0;c<b.length;c++)b[c].stop()}function l(){var b=new Blob(u,{type:t.mimeType});a(c).attr("src",URL.createObjectURL(b)),a(c).attr("muted",!1),a(c).attr("controls",!0),a(c).closest("div").removeClass("hide"),a(d).innerText=M.util.get_string("recordagain","qtype_recordrtc"),a(d).attr("disabled",!1),a(d).removeClass("btn-danger"),a(d).addClass("btn-outline-danger"),d.dataset.state="recorded",u.length>0&&e.notifyRecordingComplete()}function m(b){a(d).innerText=M.util.get_string("recordingfailed","qtype_recordrtc"),a(d).attr("disabled",!1),a(d).removeClass("btn-danger"),a(d).addClass("btn-outline-danger"),d.dataset.state="new";var c="gum"+b.name.replace("Error","").toLowerCase();e.showAlert(c)}function n(){w=f.timeLimit+1,a(d).innerHtml=M.util.get_string("stoprecording","qtype_recordrtc")+" (<span></span>)",p(),x=window.setInterval(p,1e3)}function o(){window.clearInterval(x),x=0}function p(){w-=1;var b=w%60,c=Math.round((w-b)/60);a(d).find("span").innerText=q(c)+":"+q(b),0===w&&k()}function q(a){var b=a+"";return b.length<2?"0"+b:b}function r(){var a={};a.audioBitsPerSecond=parseInt(f.audioBitRate),"video"===b.name&&(a.videoBitsPerSecond=parseInt(f.videoBitsPerSecond));for(var c=0;c<b.mimeTypes.length;c++)if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}return a}var s=null,t=null,u=[],v=0,w=0,x=0;a(d).on("click",g)}function e(e,h,i){function j(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){return a.show(),a})}function k(a){a.uploadMediaToServer()}M.util.js_pending("init-"+e);var l=document.getElementById(e),m=c();if("nowebrtc"===m)return void a(l).find(".no-webrtc-warning").removeClass("hide");if("nothttps"===m)return void a(l).find(".https-warning").removeClass("hide");var n;n="audio"===i?f:g;var o=a(l).find(".record-button button")[0],p=a(l).find(".media-player "+i)[0];this.showAlert=j,this.notifyRecordingComplete=k,new d(n,p,o,this,h),M.util.js_complete("init-"+e)}var f={name:"audio",hidePlayerDuringRecording:!0,mediaConstraints:{audio:!0},mimeTypes:["audio/webm;codecs=opus","audio/ogg;codecs=opus"]},g={name:"video",hidePlayerDuringRecording:!1,mediaConstraints:{audio:!0,video:{width:{ideal:640},height:{ideal:480}}},mimeTypes:["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]};return{init:function(a,b){new e(a,b,"audio")}}});