define(["core/log","core/modal_factory"],function(a,b){function c(){return navigator.mediaDevices&&MediaRecorder?"https:"!==location.protocol&&location.host.indexOf("localhost")===-1?"nothttps":"ok":"nowebrtc"}function d(b,c,d,e,f){function g(b){switch(a.debug("Start/stop button clicked."),b.preventDefault(),d.dataset.state){case"new":case"recorded":h();break;case"recording":k()}}function h(){d.disabled=!0,b.hidePlayerDuringRecording?c.parentElement.classList.add("hide"):c.parentElement.classList.remove("hide"),d.classList.remove("btn-outline-danger"),d.classList.add("btn-danger"),u=[],v=0,a.debug("Audio question type: Starting recording with media constraints"),a.debug(b.mediaConstraints),navigator.mediaDevices.getUserMedia(b.mediaConstraints).then(i)["catch"](m)}function i(b){s=b;var e=r();a.debug("Audio question type: creating recorder with opptions"),a.debug(e),t=new MediaRecorder(b,e),t.ondataavailable=j,t.onstop=l,a.debug("Audio question type: starting recording."),t.start(1e3),c.srcObject=b,c.setAttribute("muted",""),d.dataset.state="recording",n(),d.disabled=!1}function j(b){a.debug("Audio question type: chunk of "+b.data.size+" bytes received."),v+=b.data.size,v>=f.maxUploadSize&&(localStorage.getItem("alerted")?localStorage.removeItem("alerted"):(localStorage.setItem("alerted","true"),k(),e.showAlert("nearingmaxsize"))),u.push(b.data)}function k(){d.disabled=!0,setTimeout(function(){d.disabled=!1},1e3),o(),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),a.debug("Audio question type: stopping recording."),t.stop();for(var b=s.getTracks(),c=0;c<b.length;c++)b[c].stop()}function l(){a.debug("Audio question type: recording stopped.");var b=new Blob(u,{type:t.mimeType});c.src=URL.createObjectURL(b),c.muted=!1,c.controls=!0,c.parentElement.classList.remove("hide"),d.innerText=M.util.get_string("recordagain","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="recorded",u.length>0&&e.notifyRecordingComplete(this)}function m(b){a.debug("Audio question type: error received"),a.debug(b),d.innerText=M.util.get_string("recordingfailed","qtype_recordrtc"),d.disabled=!1,d.classList.remove("btn-danger"),d.classList.add("btn-outline-danger"),d.dataset.state="new";var c="gum"+b.name.replace("Error","").toLowerCase();e.showAlert(c)}function n(){w=f.timeLimit+1,d.innerHTML=M.util.get_string("stoprecording","qtype_recordrtc")+" (<span></span>)",p(),x=setInterval(p,1e3)}function o(){0!==x&&(clearInterval(x),x=0)}function p(){w-=1;var a=w%60,b=Math.round((w-a)/60);d.querySelector("span").innerText=q(b)+":"+q(a),0===w&&k()}function q(a){var b=a+"";return b.length<2?"0"+b:b}function r(){var a={};a.audioBitsPerSecond=parseInt(f.audioBitRate,10),"video"===b.name&&(a.videoBitsPerSecond=parseInt(f.videoBitRate,10));for(var c=0;c<b.mimeTypes.length;c++)if(MediaRecorder.isTypeSupported(b.mimeTypes[c])){a.mimeType=b.mimeTypes[c];break}return a}var s=null,t=null,u=[],v=0,w=0,x=0;d.addEventListener("click",g)}function e(e,h,i){function j(a){return b.create({type:b.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){return a.show(),a})}function k(b){a.debug(b)}M.util.js_pending("init-"+e);var l=document.getElementById(e),m=c();if("nowebrtc"===m)return void l.querySelector(".no-webrtc-warning").classList.remove("hide");if("nothttps"===m)return void l.querySelector(".https-warning").classList.remove("hide");var n;n="audio"===i?f:g;var o=l.querySelector(".record-button button"),p=l.querySelector(".media-player "+i);this.showAlert=j,this.notifyRecordingComplete=k,new d(n,p,o,this,h),M.util.js_complete("init-"+e)}var f={name:"audio",hidePlayerDuringRecording:!0,mediaConstraints:{audio:!0},mimeTypes:["audio/webm;codecs=opus","audio/ogg;codecs=opus"]},g={name:"video",hidePlayerDuringRecording:!1,mediaConstraints:{audio:!0,video:{width:{ideal:640},height:{ideal:480}}},mimeTypes:["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]};return{init:function(a,b){new e(a,b,"audio")}}});