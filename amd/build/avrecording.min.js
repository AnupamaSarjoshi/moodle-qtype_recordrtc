define(["jquery"],function(a){var b={abstractmodule:{showAlert:function(a,b){Y.use("moodle-core-notification-alert",function(){var c=new M.core.alert({title:M.util.get_string(a+"_title","qtype_recordrtc"),message:M.util.get_string(a,"qtype_recordrtc")});b&&c.after("complete",b)})},handleGumErrors:function(a,c){var d=M.util.get_string("recordingfailed","qtype_recordrtc"),e=function(){c.onMediaStopped(d)},f="gum"+a.name.replace("Error","").toLowerCase();b.abstractmodule.showAlert(f,e)},selectRecOptions:function(a){var c,d;"audio"===a?(c=["audio/webm;codecs=opus","audio/ogg;codecs=opus"],d={audioBitsPerSecond:b.commonmodule.audioBitRate}):(c=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"],d={audioBitsPerSecond:b.commonmodule.audioBitRate,videoBitsPerSecond:0});var e=c.filter(function(a){return window.MediaRecorder.isTypeSupported(a)});return 0!==e.length&&(d.mimeType=e[0]),d}},commonmodule:{questionDiv:null,audioBitRate:null,timelimit:null,saveFileUrl:null,alertWarning:null,alertDanger:null,player:null,playerDOM:null,startStopBtn:null,uploadBtn:null,countdownSeconds:null,countdownTicker:null,recType:null,stream:null,mediaRecorder:null,chunks:null,blobSize:null,maxUploadSize:null,captureUserMedia:function(a,b,c){window.navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},handleDataAvailable:function(a){b.commonmodule.chunks.push(a.data),b.commonmodule.blobSize+=a.data.size,b.commonmodule.blobSize>=b.commonmodule.maxUploadSize&&(window.localStorage.getItem("alerted")?window.localStorage.removeItem("alerted"):(window.localStorage.setItem("alerted","true"),b.commonmodule.startStopBtn.simulate("click"),b.abstractmodule.showAlert("nearingmaxsize")),b.commonmodule.chunks.pop())},handleStop:function(){var a=new window.Blob(b.commonmodule.chunks,{type:b.commonmodule.mediaRecorder.mimeType});b.commonmodule.player.attr("src",window.URL.createObjectURL(a)),b.commonmodule.player.attr("muted",!1),b.commonmodule.player.attr("controls",!0),b.commonmodule.player.parent().parent().removeClass("hide"),b.commonmodule.uploadBtn.parent().parent().removeClass("hide"),b.commonmodule.uploadBtn.innerText=M.util.get_string("attachrecording","qtype_recordrtc"),b.commonmodule.uploadBtn.attr("disabled",!1),b.commonmodule.uploadBtn.on("click",function(){0===b.commonmodule.chunks.length?b.abstractmodule.showAlert("norecordingfound"):(b.commonmodule.uploadBtn.attr("disabled",!0),b.commonmodule.uploadToServer(b.commonmodule.recType,function(a,c){"ended"===a?(b.commonmodule.uploadBtn.attr("disabled",!1),b.commonmodule.insert_annotation(b.commonmodule.recType,c)):"upload-failed"===a?(b.commonmodule.uploadBtn.attr("disabled",!1),b.commonmodule.uploadBtn.innerText=M.util.get_string("uploadfailed","qtype_recordrtc")+" "+c):"upload-failed-404"===a?(b.commonmodule.uploadBtn.attr("disabled",!1),b.commonmodule.uploadBtn.innerText=M.util.get_string("uploadfailed404","qtype_recordrtc")):"upload-aborted"===a?(b.commonmodule.uploadBtn.attr("disabled",!1),b.commonmodule.uploadBtn.innerText=M.util.get_string("uploadaborted","qtype_recordrtc")+" "+c):b.commonmodule.uploadBtn.innerText=a}))})},startRecording:function(a,c){var d=b.abstractmodule.selectRecOptions(a);b.commonmodule.mediaRecorder=new window.MediaRecorder(c,d),b.commonmodule.mediaRecorder.ondataavailable=b.commonmodule.handleDataAvailable,b.commonmodule.mediaRecorder.onstop=b.commonmodule.handleStop,b.commonmodule.mediaRecorder.start(1e3),b.commonmodule.player.attr("muted",!0),b.commonmodule.countdownSeconds=b.commonmodule.timelimit,b.commonmodule.countdownSeconds++;var e=M.util.get_string("stoprecording","qtype_recordrtc");e+=' (<span id="minutes"></span>:<span id="seconds"></span>)',b.commonmodule.startStopBtn.innerHtml=e,b.commonmodule.setTime(),b.commonmodule.countdownTicker=window.setInterval(b.commonmodule.setTime,1e3),b.commonmodule.startStopBtn.attr("disabled",!1)},stopRecording:function(a){b.commonmodule.mediaRecorder.stop();for(var c=a.getTracks(),d=0;d<c.length;d++)c[d].stop()},uploadToServer:function(a,c){var d=new window.XMLHttpRequest;d.open("GET",b.commonmodule.player.attr("src"),!0),d.responseType="blob",d.onload=function(){if(200===d.status){var e=this.response,f=(1e3*Math.random()).toString().replace(".","");f+="audio"===a?"-audio.ogg":"-video.webm";var g=new window.FormData,h=b.commonmodule.saveFileUrl,i=window.Object.keys(h.repositories);g.append("repo_upload_file",e,f),g.append("itemid",h.itemid);for(var j=0;j<i.length;j++)if("upload"===h.repositories[i[j]].type){g.append("repo_id",h.repositories[i[j]].id);break}g.append("env",h.env),g.append("sesskey",M.cfg.sesskey),g.append("client_id",h.client_id),g.append("savepath","/"),g.append("ctx_id",h.context.id);var k=M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload";b.commonmodule.makeXmlHttpRequest(k,g,function(a,b){"upload-ended"===a?c("ended",window.JSON.parse(b).url):c(a)})}},d.send()},makeXmlHttpRequest:function(a,b,c){var d=new window.XMLHttpRequest;d.onreadystatechange=function(){4===d.readyState&&200===d.status?c("upload-ended",d.responseText):404===d.status&&c("upload-failed-404")},d.upload.onprogress=function(a){c(Math.round(a.loaded/a.total*100)+"% "+M.util.get_string("uploadprogress","qtype_recordrtc"))},d.upload.onerror=function(a){c("upload-failed",a)},d.upload.onabort=function(a){c("upload-aborted",a)},d.open("POST",a),d.send(b)},pad:function(a){var b=a+"";return b.length<2?"0"+b:b},setTime:function(){b.commonmodule.countdownSeconds--,b.commonmodule.startStopBtn.one("span#seconds").innerText=b.commonmodule.pad(b.commonmodule.countdownSeconds%60),b.commonmodule.startStopBtn.one("span#minutes").innerText=b.commonmodule.pad(window.parseInt(b.commonmodule.countdownSeconds/60,10)),0===b.commonmodule.countdownSeconds&&b.commonmodule.startStopBtn.simulate("click")}},audiomodule:{init:function(c){b.commonmodule.questionDiv=a(document.getElementById(c)),b.commonmodule.audioBitRate=b.commonmodule.questionDiv.data("audioBitRate"),b.commonmodule.timelimit=b.commonmodule.questionDiv.data("timelimit"),b.commonmodule.alertWarning=b.commonmodule.questionDiv.find("div#alert-warning"),b.commonmodule.alertDanger=b.commonmodule.questionDiv.find("div#alert-danger"),b.commonmodule.player=b.commonmodule.questionDiv.find("audio#player"),b.commonmodule.playerDOM=document.getElementById(c).querySelector("audio#player"),b.commonmodule.startStopBtn=b.commonmodule.questionDiv.find("button#start-stop"),b.commonmodule.uploadBtn=b.commonmodule.questionDiv.find("button#upload"),b.commonmodule.recType="audio",b.commonmodule.maxUploadSize=b.commonmodule.questionDiv.data("maxUploadSize"),b.compatcheckmodule.checkHasGum(),b.compatcheckmodule.checkIsHttps(),b.commonmodule.startStopBtn.on("click",function(){if(b.commonmodule.startStopBtn.attr("disabled",!0),b.commonmodule.startStopBtn[0].innerText===M.util.get_string("startrecording","qtype_recordrtc")||b.commonmodule.startStopBtn[0].innerText===M.util.get_string("recordagain","qtype_recordrtc")||b.commonmodule.startStopBtn[0].innerText===M.util.get_string("recordingfailed","qtype_recordrtc")){b.commonmodule.player.parent().parent().addClass("hide"),b.commonmodule.uploadBtn.parent().parent().addClass("hide"),b.commonmodule.startStopBtn.removeClass("btn-outline-danger"),b.commonmodule.startStopBtn.addClass("btn-danger"),b.commonmodule.chunks=[],b.commonmodule.blobSize=0,b.commonmodule.uploadBtn.detach("click");var a={onMediaCaptured:function(a){b.commonmodule.stream=a,b.commonmodule.startRecording(b.commonmodule.recType,b.commonmodule.stream)},onMediaStopped:function(a){b.commonmodule.startStopBtn.innerText=a,b.commonmodule.startStopBtn.attr("disabled",!1),b.commonmodule.startStopBtn.removeClass("btn-danger"),b.commonmodule.startStopBtn.addClass("btn-outline-danger")},onMediaCapturingFailed:function(c){b.abstractmodule.handleGumErrors(c,a)}};b.audiomodule.captureAudio(a)}else window.clearInterval(b.commonmodule.countdownTicker),window.setTimeout(function(){b.commonmodule.startStopBtn.attr("disabled",!1)},1e3),b.commonmodule.stopRecording(b.commonmodule.stream),b.commonmodule.startStopBtn.innerText=M.util.get_string("recordagain","qtype_recordrtc"),b.commonmodule.startStopBtn.removeClass("btn-danger"),b.commonmodule.startStopBtn.addClass("btn-outline-danger")})},captureAudio:function(a){b.commonmodule.captureUserMedia({audio:!0},function(c){b.commonmodule.playerDOM.srcObject=c,a.onMediaCaptured(c)},function(b){a.onMediaCapturingFailed(b)})}},videomodule:{init:function(c){b.commonmodule.questionDiv=a(document.getElementById(c)),b.commonmodule.audioBitRate=b.commonmodule.questionDiv.data("audioBitRate"),b.commonmodule.timelimit=b.commonmodule.questionDiv.data("timelimit"),b.commonmodule.alertWarning=b.commonmodule.questionDiv.find("div#alert-warning"),b.commonmodule.alertDanger=b.commonmodule.questionDiv.find("div#alert-danger"),b.commonmodule.player=b.commonmodule.questionDiv.find("audio#player"),b.commonmodule.playerDOM=document.getElementById(c).querySelector("audio#player"),b.commonmodule.startStopBtn=b.commonmodule.questionDiv.find("button#start-stop"),b.commonmodule.uploadBtn=b.commonmodule.questionDiv.find("button#upload"),b.commonmodule.recType="video",b.commonmodule.maxUploadSize=b.commonmodule.questionDiv.data("maxUploadSize"),b.compatcheckmodule.checkHasGum(),b.compatcheckmodule.checkIsHttps(),b.commonmodule.startStopBtn.on("click",function(){if(b.commonmodule.startStopBtn.attr("disabled",!0),b.commonmodule.startStopBtn.innerText===M.util.get_string("startrecording","qtype_recordrtc")||b.commonmodule.startStopBtn.innerText===M.util.get_string("recordagain","qtype_recordrtc")||b.commonmodule.startStopBtn.innerText===M.util.get_string("recordingfailed","qtype_recordrtc")){b.commonmodule.uploadBtn.parent().parent().addClass("hide"),b.commonmodule.startStopBtn.removeClass("btn-outline-danger"),b.commonmodule.startStopBtn.addClass("btn-danger"),b.commonmodule.chunks=[],b.commonmodule.blobSize=0,b.commonmodule.uploadBtn.detach("click");var a={onMediaCaptured:function(a){b.commonmodule.stream=a,b.commonmodule.stream=a,b.commonmodule.startRecording(b.commonmodule.recType,b.commonmodule.stream)},onMediaStopped:function(a){b.commonmodule.startStopBtn.innerText=a,b.commonmodule.startStopBtn.attr("disabled",!1),b.commonmodule.startStopBtn.removeClass("btn-danger"),b.commonmodule.startStopBtn.addClass("btn-outline-danger")},onMediaCapturingFailed:function(c){b.abstractmodule.handleGumErrors(c,a)}};b.commonmodule.player.parent().parent().removeClass("hide"),b.commonmodule.player.attr("controls",!1),b.videomodule.captureAudioVideo(a)}else window.clearInterval(b.commonmodule.countdownTicker),window.setTimeout(function(){b.commonmodule.startStopBtn.attr("disabled",!1)},1e3),b.commonmodule.stopRecording(b.commonmodule.stream),b.commonmodule.startStopBtn.innerText=M.util.get_string("recordagain","qtype_recordrtc"),b.commonmodule.startStopBtn.removeClass("btn-danger"),b.commonmodule.startStopBtn.addClass("btn-outline-danger")})},captureAudioVideo:function(a){b.commonmodule.captureUserMedia({audio:!0,video:{width:{ideal:640},height:{ideal:480}}},function(c){b.commonmodule.playerDOM.srcObject=c,b.commonmodule.playerDOM.play(),a.onMediaCaptured(c)},function(b){a.onMediaCapturingFailed(b)})}},compatcheckmodule:{checkHasGum:function(){!navigator.mediaDevices||!window.MediaRecorder},checkIsHttps:function(){var a="https:"===window.location.protocol||window.location.host.indexOf("localhost")!==-1;a||b.commonmodule.alertDanger.parent().parent().removeClass("hide")}},init:function(a){M.util.js_pending("init-"+a),b.audiomodule.init(a),M.util.js_complete("init-"+a)}};return b});