define ("qtype_recordrtc/avrecording",["exports","core/log","core/modal_factory","core/notification"],function(a,b,c,d){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=function(a,b){M.util.js_pending("init-"+a);new i(a,b);M.util.js_complete("init-"+a)};b=e(b);c=e(c);d=e(d);var j="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function e(a){return a&&a.__esModule?a:{default:a}}function f(){if(!(navigator.mediaDevices&&window.MediaRecorder)){return"nowebrtc"}if(!("https:"===location.protocol||-1!==location.host.indexOf("localhost"))){return"nothttps"}return"ok"}var k=("function"==typeof j.define&&j.define.amd?new Promise(function(a,b){j.require([M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"],a,b)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&j.require&&"component"===j.require.loader?Promise.resolve(require((M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"))):Promise.resolve(j[M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js"])).then(function(){return"function"==typeof j.define&&j.define.amd?new Promise(function(a,b){j.require([M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"],a,b)}):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&j.require&&"component"===j.require.loader?Promise.resolve(require((M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"))):Promise.resolve(j[M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/index.umd.js"])}).then(function(a){var c=a.Mp3MediaRecorder,d=URL.createObjectURL(new Blob(["importScripts('"+M.cfg.wwwroot+"/question/type/recordrtc/js/mp3-mediarecorder@4.0.5/worker.umd.js');","mp3EncoderWorker.initMp3MediaEncoder({vmsgWasmUrl: '"+M.cfg.wwwroot+"/question/type/recordrtc/js/vmsg@0.4.0/vmsg.wasm'});"],{type:"application/javascript"}));return function(a,e,f,g){var H=this,I=null,J=null,K=[],L=0,N=0,O=0,P=0,Q=a.querySelector("button.qtype_recordrtc-main-button"),R=a.querySelector(".qtype_recordrtc-pause-button button"),S=a.querySelector(".qtype_recordrtc-control-row"),T=a.querySelector(".qtype_recordrtc-media-player "+e.name),U=a.querySelector(".qtype_recordrtc-no-recording-placeholder"),V=a.querySelector(".qtype_recordrtc-time-left");a.addEventListener("click",function(b){var c=b.target.closest("button");if(!c){return}b.preventDefault();switch(a.dataset.state){case"new":case"recorded":h();break;case"starting":j();break;case"recording":if(c===R){l()}else{n()}break;case"paused":if(c===R){m()}else{n()}break;}});this.uploadMediaToServer=function(){A("uploadpreparing");var a=new XMLHttpRequest;a.open("GET",T.src);a.responseType="blob";a.addEventListener("load",v);a.send()};function h(){if("audio"===e.name){T.parentElement.classList.add("hide");U.classList.add("hide");V.classList.remove("hide")}else{T.parentElement.classList.remove("hide");U.classList.add("hide")}null===R||void 0===R?void 0:R.parentElement.classList.remove("hide");Q.classList.remove("btn-outline-danger");Q.classList.add("btn-danger");F();K=[];L=0;navigator.mediaDevices.getUserMedia(e.mediaConstraints).then(i).catch(p)}function i(b){I=b;T.srcObject=b;T.muted=!0;if("audio"===e.name){j()}else{T.play();T.controls=!1;a.dataset.state="starting";A("startrecording");a.querySelector(".qtype_recordrtc-stop-button").disabled=!1}if(R){R.disabled=!1}Q.disabled=!1;Q.focus()}function j(){if("audio"===e.name){J=new c(I,{worker:new Worker(d)})}else{J=new MediaRecorder(I,D())}J.ondataavailable=k;J.onpause=k;J.onstop=o;J.start(1e3);a.dataset.state="recording";A("stoprecording");q();if("video"===e.name){Q.parentElement.classList.add("hide");S.classList.remove("hide");S.classList.add("d-flex")}}function k(a){if(!a.data){return}L+=a.data.size;if(0<=g.maxUploadSize&&L>=g.maxUploadSize){if(!localStorage.getItem("alerted")){localStorage.setItem("alerted","true");n();f.showAlert("nearingmaxsize")}else{localStorage.removeItem("alerted")}}K.push(a.data);if("undefined"!=typeof M.core_formchangechecker&&!window.location.pathname.endsWith("/question/preview.php")){M.core_formchangechecker.set_form_changed()}}function l(){r();B("resume");J.pause();a.dataset.state="paused"}function m(){s();a.dataset.state="recording";B("pause");J.resume()}function n(){Q.disabled=!0;r();Q.classList.remove("btn-danger");Q.classList.add("btn-outline-danger");if(R){B("pause");R.parentElement.classList.add("hide")}J.stop();for(var a=I.getTracks(),b=0;b<a.length;b++){a[b].stop()}}function o(){if("new"===a.dataset.state){return}var b=new Blob(K,{type:J.mimeType});T.srcObject=null;T.src=URL.createObjectURL(b);T.muted=!1;T.controls=!0;T.parentElement.classList.remove("hide");U.classList.add("hide");T.focus();if("audio"===e.name){V.classList.add("hide")}else{Q.parentElement.classList.remove("hide");S.classList.add("hide");S.classList.remove("d-flex")}Q.disabled=!0;Q.classList.remove("btn-danger");Q.classList.add("btn-outline-danger");a.dataset.state="recorded";if(0<K.length){f.notifyRecordingComplete(H)}}function p(c){b.default.debug("Audio/video question: error received");b.default.debug(c);C("recordingfailed");A("recordagainx");Q.classList.remove("btn-danger");Q.classList.add("btn-outline-danger");a.dataset.state="new";if(J){J.stop()}var d="gum"+c.name.replace("Error","").toLowerCase();f.showAlert(d);E()}function q(){N=1e3*a.dataset.maxRecordingDuration;s();t()}function r(){N=O-Date.now();if(0!==P){clearInterval(P);P=0}}function s(){O=Date.now()+N;if(0===P){P=setInterval(t,100)}}function t(){var a=O-Date.now(),b=Math.round(a/1e3),c=b%60,d=Math.round((b-c)/60);V.innerText=M.util.get_string("timedisplay","qtype_recordrtc",{mins:u(d),secs:u(c)});if(0>=a){n()}}function u(a){var b=a+"";if(2>b.length){return"0"+b}else{return""+b}}function v(b){var c=b.target;if(200!==c.status){return}var d=c.response,e=new FormData;e.append("repo_upload_file",d,a.dataset.recordingFilename);e.append("sesskey",M.cfg.sesskey);e.append("repo_id",g.uploadRepositoryId);e.append("itemid",g.draftItemId);e.append("savepath","/");e.append("ctx_id",g.contextId);e.append("overwrite","1");var f=new XMLHttpRequest;f.addEventListener("readystatechange",w);f.upload.addEventListener("progress",x);f.addEventListener("error",y);f.addEventListener("abort",z);f.open("POST",M.cfg.wwwroot+"/repository/repository_ajax.php?action=upload");f.send(e)}function w(a){var b=a.target;if(4!==b.readyState){return}var c=JSON.parse(b.responseText);if(c.errorcode){y()}if(200===b.status){A("recordagainx");E()}else if(404===b.status){C("uploadfailed404");E()}}function x(a){A("uploadprogress",Math.round(100*(a.loaded/a.total))+"%")}function y(){C("uploadfailed");E()}function z(){C("uploadaborted");E()}function A(b,c){if(!c){c="<span class=\"sr-only\"> "+a.dataset.widgetName+"</span>"}Q.innerHTML=M.util.get_string(b,"qtype_recordrtc",c)}function B(a){R.innerText=M.util.get_string(a,"qtype_recordrtc")}function C(a){U.textContent=M.util.get_string(a,"qtype_recordrtc");T.parentElement.classList.add("hide");U.classList.remove("hide")}function D(){var a={};if("audio"===e.name){a.audioBitsPerSecond=e.bitRate}else if("video"===e.name){a.videoBitsPerSecond=e.bitRate;a.videoWidth=e.width;a.videoHeight=e.height;for(var b=0;b<e.mimeTypes.length;b++){if(MediaRecorder.isTypeSupported(e.mimeTypes[b])){a.mimeType=e.mimeTypes[b];break}}}return a}function E(){G(!0);f.notifyButtonStatesChanged()}function F(){G(!1)}function G(){var b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1;a.closest(".que").querySelectorAll("button, input[type=submit], input[type=button]").forEach(function(a){a.disabled=!b})}}});function g(a){this.name="audio";this.bitRate=parseInt(a,10);this.mediaConstraints={audio:!0};this.mimeTypes=["audio/mpeg"]}function h(a,b,c){this.name="video";this.bitRate=parseInt(a,10);this.width=parseInt(b,10);this.height=parseInt(c,10);this.mediaConstraints={audio:!0,video:{width:{ideal:this.width},height:{ideal:this.height}}};this.mimeTypes=["video/webm;codecs=vp9,opus","video/webm;codecs=h264,opus","video/webm;codecs=vp8,opus"]}function i(a,b){var j=document.getElementById(a),l=f();if("nothttps"===l){j.querySelector(".https-warning").classList.remove("hide");return}else if("nowebrtc"===l){j.querySelector(".no-webrtc-warning").classList.remove("hide");return}this.showAlert=i;this.notifyRecordingComplete=function(a){a.uploadMediaToServer()};this.notifyButtonStatesChanged=e;var m=this;j.querySelectorAll(".qtype_recordrtc-audio-widget, .qtype_recordrtc-video-widget").forEach(function(a){var c;if("audio"===a.dataset.mediaType){c=new g(b.audioBitRate)}else{c=new h(b.videoBitRate,b.videoWidth,b.videoHeight)}k.then(function(d){new d(a,c,m,b);return"Not used"}).catch(d.default.exception)});e();function e(){var a=!1;j.querySelectorAll(".qtype_recordrtc-audio-widget, .qtype_recordrtc-video-widget").forEach(function(b){if("recorded"===b.dataset.state){a=!0}});var b=j.querySelector("input.submit[type=submit]");if(b){b.disabled=!a}}function i(a){return c.default.create({type:c.default.types.ALERT,title:M.util.get_string(a+"_title","qtype_recordrtc"),body:M.util.get_string(a,"qtype_recordrtc")}).then(function(a){a.show();return a})}}});
//# sourceMappingURL=avrecording.min.js.map
